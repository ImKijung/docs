---
id: java
title: Java
description: JVM 환경에서 동작하는 모든 애플리케이션에 적용할 수 있는 에이전트 설치 방법입니다.
tags:
    - Java
---
와탭 모니터링 서비스를 사용하기 위해서는 회원 가입 후 프로젝트를 생성하고 대상 서버에 에이전트를 설치해야 합니다.

다음 동영상 가이드를 참조하세요.

{@youtube: QXKweGBucjI}

에이전트를 설치하고 적용하기 전에 [지원 환경](supported-spec#java)을 먼저 확인하고 다음의 과정대로 진행하세요.

## 에이전트 다운로드

{@include: ../getting-started/_download-java-agent.mdx}

## *whatap.conf* 파일 설정하기

{@include: ../getting-started/_whatap_conf.mdx}

## JVM 옵션 추가

{@include: ../getting-started/_add-jvmopt.mdx}

### Tomcat 환경

#### **Linux**  
*catalina.sh* 파일 상단에 ```JAVA_OPTS```을 추가하세요.

```bash text title='{Tomcat 설치 경로}/bin/catalina.sh' {2,4} showLineNumbers
########## WHATAP START ############
WHATAP_HOME=/whatap
WHATAP_JAR=`ls ${WHATAP_HOME}/whatap.agent-*.jar | sort | tail -1`
JAVA_OPTS="${JAVA_OPTS} -javaagent:${WHATAP_JAR} "
########## WHATAP END ############
```

#### **Windows**

* **Tomcat** 서비스로 실행하는 경우
    1. 프로그램 메뉴에서 **Configure Tomcat** 또는 **톰캣 설치 폴더** */bin* 경로의 *tomcat<톰캣버전>w.exe* 파일을 실행하세요.
    1. ***Java*** 탭을 클릭하세요.
    1. ***Java Options*** 항목에 Whatap 에이전트를 등록하세요.
    ```text
    -javaagent:<와탭설치경로>/whatap.agent-<version>.jar
    ```
    ![Apache Tomcat](https://img.whatap.io/media/images/tomcat-win.png)

* *setup.bat* 파일을 통해 실행하는 경우  
     *catalina.bat* 파일 상단에 ```JAVA_OPT```를 추가하세요.
    ```batch title='{Tomcat 설치 경로}/bin/catalina.bat' {2,5} showLineNumbers
    rem ########## WHATAP START ############
    set WHATAP_HOME=C:\whatap
    for /f %%f in ('dir /b /on "%WHATAP_HOME%\whatap.agent-*.jar"') do set last=%%f
    set WHATAP_JAR=%last%
    set WHATAP_OPTS=-javaagent:%WHATAP_HOME%\%WHATAP_JAR%

    if "x%JAVA_OPTS%"=="x" goto setWhatap

    set JAVA_OPTS_TMP=%JAVA_OPTS:"=%
    if not "x%JAVA_OPTS_TMP:whatap=%"=="x%JAVA_OPTS_TMP%" goto endWhatap

    :setWhatap
    set JAVA_OPTS=%JAVA_OPTS% %WHATAP_OPTS%

    :endWhatap
    rem ########## WHATAP END ############
    ```

### PaaS 환경

**Platform as a Service(PaaS)** 환경은 배포 대상 애플리케이션에 WhaTap Agent와 설정을 포함해 배포합니다.

#### IBM BlueMix

[IBM BlueMix](https://console.bluemix.net/docs/apps/index.html%E2%80%8B)는 컨테이너로 WebSphere Liberty 환경을 제공합니다. Liberty는 WebSphere Application Server와 다른 경량화 환경으로 Spring Boot가 동작하는 방식과 유사합니다.

다음은 설정 환경 예제입니다. 가이드에 따른 환경을 구성할 경우 로컬 개발 환경에서 생성하는 파일들입니다.

```bash
whatap@vmwas01:/apps/bluemix/java-helloworld$ ls -alrt
합계 64
drwxrwxr-x 3 whatap whatap  4096 10월 29 13:13 ..
-rw-rw-r-- 1 whatap whatap  1079 10월 29 13:13 .classpath
-rw-rw-r-- 1 whatap whatap  1184 10월 29 13:13 .project
-rw-rw-r-- 1 whatap whatap    39 10월 29 13:13 .gitignore
-rw-rw-r-- 1 whatap whatap   151 10월 29 13:13 CONTRIBUTING.md
drwxrwxr-x 2 whatap whatap  4096 10월 29 13:13 .settings
-rw-rw-r-- 1 whatap whatap  2823 10월 29 13:13 pom.xml
-rw-rw-r-- 1 whatap whatap   122 10월 29 13:13 manifest.yml
-rw-rw-r-- 1 whatap whatap  3522 10월 29 13:13 README.md
-rw-rw-r-- 1 whatap whatap 11323 10월 29 13:13 LICENSE
drwxrwxr-x 3 whatap whatap  4096 10월 29 13:13 src
drwxrwxr-x 2 whatap whatap  4096 10월 29 13:13 target
drwxrwxr-x 8 whatap whatap  4096 10월 29 13:13 .git
drwxrwxr-x 6 whatap whatap  4096 10월 29 15:26 .
```

1. ```${APP_HOME}```에서 *src/main/resources/whatap-agent/* 디렉토리를 생성하고 jar 파일, conf 파일을 복사하세요.
    ```bash
    $ mkdir -p src/main/resources/whatap-agent/
    $ cp /apps/whatap/whatap.agent.tracer-1.5.4.jar src/main/resources/whatap-agent/
    $ cp /apps/whatap/whatap.conf src/main/resources/whatap-agent/
    ```
1. *${APP_HOME}/manifest.yml* 파일에 옵션을 추가하세요. yml 파일이므로 공백, 들여쓰기 기준을 잘 맞춰 작성하세요.
    ```yaml title=${APP_HOME}/manifest.yml {7-9} showLineNumbers
    ---
    applications:
    - name: sample-java-helloworld
    random-route: true
    memory: 256M
    path: target/JavaHelloWorldApp.war
    #여기서부터 추가합니다.
    env:
        JAVA_OPTS: "-javaagent:/{APPLICATION_DIR}/WEB-INF/classes/whatap-agent/whatap.agent.tracer-1.5.4.jar -Dorg.osgi.framework.bootdelegation=whatap.* "
    ```

:::note
* *whatap.conf* 설정은 PaaS가 아닌 환경과 동일하게 적용합니다. 적용 후 에이전트 명 식별에 어려울 수 있으니 상황에 맞는 에이전트 명을 적용하세요.
* 에이전트 네이밍에 관한 자세한 내용은 ~~에이전트 설정하기 / 애플리케이션 / 네이밍~~에서 확인하세요.
:::

#### Elastic Beanstalk

**Elastic Beanstalk**를 사용해 배포할 경우 Whatap 서비스를 적용하는 방법입니다. 

1. Spring Boot 결과물을 jar로 배포할 경우 *.ebextensions*의 내용을 적용할 수 없습니다. 다음 파일들을 압축해 zip 형태로 배포하세요.

    * *.elasticbeanstalk/config.yml* : eb 명령을 실행하는 디렉토리 하위에 자동 생성
    * *.ebextensions/{config_name}.config* : eb 설정 파일
    * *Procfile* : JVM command line 옵션을 설정하기 위한 파일
    * *{application}.jar* : 실행할 applicaion.jar 파일

1. Service에 적용할 **whatap agent**의 파일을 압축해 S3(혹은 다운로드할 수 있는 public 경로)에 업로드하세요.

    * *paramkey.txt*
    * *whatap.agent-2.0_25.jar*
    * *whatap.conf*

    ```bash title='디렉토리 압축하기'
    zip -r whatap-agent.zip agent
    ```

1. *.ebextension/{config_name}.config*" 파일에 다운로드할 **whatap agent** 경로를 입력하세요.  
    다운로드할 수 있도록 압축 파일 형태로 만들어 둔 경우 eb를 실행해 자동으로 다운로드한 다음 압축을 풉니다.

    ```yaml title=ebextension/{config_name}.config
    sources:
      target directory:
        S3경로
    ```

    ```yaml title=예시
    sources:
      /home/webapp:
        http://s3.ap-northeast-2.amazonaws.com/{bucket-name}/whatap-agent.zip
    ```

1. **whatap agent**의 옵션을 추가한 JVM command를 입력해 *Procfile*을 작성하세요.

    ```yaml title=Procfile
    web: java -javaagent:${WHATAP_JAR_FILE_PATH} -Dwhatap.name=${WHATAP_NAME} -Dwhatap.okind=${WHATAP_OKIND_NAME} -Dwhatap.server.home=${APPLICAION_PATH} -Dwhatap.conf.path=${WHATAP_HOME} -jar ${APPLICAIONT}.jar
    ```

    ```yaml title=예시
    web: java -javaagent:/home/webapp/agent/whatap.agent-2.0_25.jar -Dwhatap.name=bootTest -Dwhatap.okind=test -Dwhatap.server.home=/var/app/current -Dwhatap.conf.path=/home/webapp/agent -jar whatap-boot-test.jar
    ```

1. *Procfile* 파일과 *.ebextensions* 파일, *{application}.jar* 파일을 압축하세요.

    ```bash
    zip -r {application}.zip Procfile .ebextensions/ {application}.jar
    ```
1. *.elasticbeanstalk/config.yml* 파일에 배포할 zip파일 경로를 추가하세요.

    ```yaml
    deploy:
      artifact: /path/to/{application}.zip
    ```

1. eb 배포 명령어를 실행하세요.

    ```bash
    eb deploy
    ```

자세한 내용은 ~~AWS 가이드 문서~~를 참고하세요.

### Docker 환경

기존 Docker 이미지를 바탕으로 **WhaTap** 설정을 추가한 이미지를 빌드하세요.

1. Docker 빌드 디렉토리를 생성하세요.

    ```bash
    mkdir -p {Docker build dir}
    ```

1. *whatap.conf* 파일을 생성하세요.
    <!-- 담당자에게 명령어 확인 필요 -->
    ```docker {3,5} showLineNumbers
    cat <<EOF >{Docker build Dir}/whatap.conf 
    #프로젝트 라이선스 키를 입력하세요.
    license=XXXXXXXXXXXXXX-XXXXXXXXXXXXXX-XXXXXXXXXXXXXX 
    #Proxy IP 정보를 입력하세요.
    whatap.server.host=xx.xx.xx.xx/yy.yy.yy.yy 
    EOF
    ```

1. Dockerfile을 생성합니다.  
    이미지를 빌드 할 경우 와탭 이미지에서 ```-javaagent``` 옵션에 적용할 jar 파일을 복사할 수 있습니다.
    <!-- 담당자에게 명령어 확인 필요 -->
    ```docker
    cat <<EOF >/home/silver/whatap/docker/Dockerfile 
    FROM whatap/kube_mon as build
    #실제 이미지 생성 (기존 이미지에 Whatap 추가)
    #$Image_Name(이미지명)
    FROM $Image_Name
    RUN mkdir -p /whatap
    COPY --from=build /data/agent/micro/whatap.agent-*.jar /whatap
    COPY ./whatap.conf /whatap/
    #... {중략} ...
    EOF
    ```

1. ```JAVA_OPT```에 아래 내용을 추가하세요.
    ```apacheconf
    WHATAP_HOME=/whatap
    WHATAP_JAR=ls ${WHATAP_HOME}/whatap.agent-*.jar | sort | tail -1
    export JAVA_OPTS="-javaagent:${WHATAP_JAR} "
    ```

1. Docker를 빌드하세요.

    ```bash
    cd docker
    docker build -t $Image_Name
    ```

:::note
* Java 에이전트를 설치하는 경우에 한합니다. 와탭 쿠버네티스 모니터링과 함께 적용하는 경우 ~~별도 절차~~를 참고하세요.
* Java 에이전트 파일 이름은 ```Rename``` 기능을 활용해 수정할 수 있습니다. Java 에이전트의 이름을 수정했다면 ```JAVA_OPTS```에 새로운 Java 에이전트 이름을 등록하세요.

    ```bash title='Java 에이전트 이름 수정 방법 예시'
    java -cp whatap.agent-2.1.1.jar whatap.agent.setup.Rename -from whatap.agent-2.1.1.jar -to whatap.agent.jar
    ```
:::