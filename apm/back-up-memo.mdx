<!-- 현재 백업 페이지로 사용 중 -->

    ⓵ 옵션이 적용되면 SQL 파라미터를 암호화하여 수집합니다.

    ⓶ 옵션이 적용되면 HTTP 쿼리 파라미터를 암호화하여 수집합니다.

    ⓵ *requirements.txt*를 사용하는 경우 해당 파일에 `whatap-python`을 추가하세요.

웹 애플리케이션 서버에 트레이서를 적용하기 위한 쉘 스크립트입니다.
PHP 확장 모듈 설정, whatap.ini 설정, whatap-php 서비스 등록 등을 다룹니다. 자세한 내용은 [다음 설명서](../apm/php-extenstion-whatap)를 참조하세요. 

PHP ZTS를 지원할 경우 파일 형식은 다음과 같습니다. *whatap_zts\_```X.Y.Z```.so* 

![number-s1](/img/number-01.png) 상단 옵션 영역에서 지정한 시간 범위의 데이터를 바탕으로 ![number-s3](/img/number-03.png) 영역에 차트를 생성합니다. 
![metrics_app_counter_example_2](https://img.whatap.io/media/images/metrics_app_counter_example_2.png)
<!--
            {
              type: 'category',
              label: '분석하기',
              collapsible: true,
              collapsed: true,
              items: [
                'analysis/cube',
                {
                  type: 'category',
                  label: '보고서',
                  collapsible: true,
                  collapsed: true,
                  link: {
                    type: 'doc',
                    id: 'analysis/report-intro'
                  },
                  items: [
                    'analysis/report-apm',
                    'analysis/intergrated-report',
                  ]
                },
                'analysis/analysis-apm'
              ]
            },    
-->            

---

<!-- 파이썬 트랜잭션 엔드포인트 지정 -->

1. **메소드 프로파일 설정**  
    메소드 프로파일을 설정하세요. 해당 클래스들이 잠재적인 트랜잭션 end point보다 확실하게 트랜잭션에서 호출되는 클래스를 지정해야 합니다. 그래서 DB를 사용하는 프로그램에서는 JDBC 드라이버가 일반적으로 유용합니다.

    JDBC 드라이버에 프로파일을 설정하세요.
    ```javascript title=whatap.conf
    hook_method_patterns=jdbc.*.*
    hook_method_access_public_enabled=true
    hook_method_access_protected_enabled=true
    hook_method_access_none_enabled=true
    ```

    어느 메소드이건 호출되면 트랜잭션을 시작시킵니다. 옵션과 트랜잭션이 시작할 때 스택을 덤프 하는 옵션을 켭니다.
    ```javascript title=whatap.conf
    trace_auto_transaction_enabled=true
    trace_auto_transaction_backstack_enabled=true
    ```
1. **재시작 후 프로파일 분석**  
    다시 시작하고 서비스를 호출하면 트랜잭션이 추적되는 것을 볼 수 있습니다. 트랜잭션들을 조회해 보면 모든 jdbc.*로 시작하는 클래스의 메소드를 이 트랜잭션으로 나타남을 알 수 있습니다. 트랜잭션 프로파일을 조회하면 **TRANSACTION BACKSTACK**이라는 메시지 스텝을 확인할 수 있습니다.

    ```javascript title='TRANSACTION BACKSTACK'
    jdbc.FakePreparedStatement.executeQuery(FakePreparedStatement.java),
    com.virtual.dao.SelectDAO.execute2(SelectDAO.java:29),
    com.virtual.web.SimulaNonHttp.execute(SimulaNonHttp.java:147),
    com.virtual.web.SimulaNonHttp.process(SimulaNonHttp.java:76),
    com.virtual.web.SimulaNonHttp.run(SimulaNonHttp.java:100)
    ```

 1. **스택 내용 확인**  
    이제 어떤 메소드로부터 출발하고 있는지 추정할 수 있습니다.

    ```javascript title='예제'
    com.virtual.web.SimulaNonHttp.execute(SimulaNonHttp.java:147),
    com.virtual.web.SimulaNonHttp.process(SimulaNonHttp.java:76),
    com.virtual.web.SimulaNonHttp.run(SimulaNonHttp.java:100)
    ```

    위 3개의 메소드 중에 하나를 트랜잭션 시작점으로 판단할 수 있습니다. 이런 상황에서는 역 컴파일을 수행해서 적절한 트랜잭션 end point를 결정해야 합니다.

    :::note
    로직을 간단히 보면 *SimulaNonHttp.run* 내에서 `while()`가 돌면서 `SimulaNonHttp.process()`을 호출하고 `SimulaNonHttp.execute()`가 수행됩니다. `process()`가 적당하다는 것을 알 수 있습니다. 이 부분은 소스를 보고 판단해야 합니다.
    :::

    :::note
    **end point의 가장 중요한 기준은 종료되어야 한다는 것**입니다. 정상적인 상황에서 지연되지 않고 곧바로 종료되어야 성능적인 판단을 할 수 있습니다.
    :::

1. **트랜잭션 END POINT 지정하기**  
    트랜잭션 시작 지점을 다음과 같이 설정하세요.

    ```bash
    hook_service_patterns=com.virtual.web.SimulaNonHttp.process
    ```
    다시 시작하면 `process()` 메소드가 새로운 트랜잭션의 end point가 됩니다.

1. **트랜잭션 이름 추적하기**  
    보통의 경우에는 메소드 명칭으로 충분히 트랜잭션을 구분할 수 있습니다.

    ```javascript title=whatap.conf
    ----
    service_name_mode=[full,class,method,string,arg]
    service_name_index=0
    ----
    service_name_mode::
    full,class,method,string,arg
    5가지 옵션을 지정할 수 있습니다.
    - full : Full Class 이름 사용
    - class : Class 이름 서비스 명으로 사용
    - method : Method 이름을 서비스명으로 사용
    - string : 문자열 중에서 첫 번째 파라미터를 서비스 명으로 사용
    - arg : 파라미터중에서 **service_name_index**옵션에 지정한 인덱스를 파라미터를 서비스 명으로 사용
    ```

1. **에이전트 플러그인 사용하기**  

    :::caution
    플러그인 사용은 전문가 영역이기 때문에 충분히 이해한 경우에만 사용하길 권장합니다.
    :::

    *WHATAP_HOME* 디렉토리 아래에 plugin 디렉토리를 만드세요. 그리고 vi를 통해 *AppServiceStart.x* 파일을 만드세요.

    ![](https://img.whatap.io/media/agent_python/data/app_start_plug.png)

    `println(“test”);`라고 타이핑하고 저장하면 화면에 “test”라는 문자열이 출력되는 것을 확인할 수 있습니다. 그러면 파라미터에서 정보를 추출해 보세요. 
    
    본 예제는 파라미터에 HashMap에 전달되고 거기에 url 파라미터가 전달되고 있습니다.

    ```javascript title=JAVA
    Object url =((java.util.HashMap)$point.getArgs()[0]).get("url");
    $ctx.service((String)url);
    //println(“url=“+url);
    ```

    이렇게 플러그인을 만들면 트랜잭션 이름이 변경됩니다.

---

#### 컴팩트한 액티브 스택 수집

***액티브 스택***은 스레드 덤프를 정기적으로 수행하기 때문에 잘못 구현되면 에이전트에 오버헤드가 커질 수 있습니다. 와탭은 에이전트 부하를 최소화하면서 액티브 스택을 수집하기 위해 다양한 옵션들을 가지고 있습니다.

:::note
***서버*** > ***더보기*** > ***스레드 목록/덤프*** 메뉴에서 스레드 목록 중에 `WhaTap-ActiveStackDump` 스레드의 CPU Time을 확인하면 오버헤드를 판단할 수 있습니다.
:::

```java title='액티브 스택 예시'
java.lang.StringBuffer.append(StringBuffer.java:309)
java.util.regex.Matcher.appendReplacement(Matcher.java:839)
java.util.regex.Matcher.replaceAll(Matcher.java:906)
java.lang.String.replaceAll(String.java:2162)
core.log.triggers.TriggerRegister.changeNotify(TriggerRegister.java:114)
core.log.aop.handler.DaoInfo.log(DaoInfo.java:141)
core.log.aop.handler.DaoInfo.doAround(DaoInfo.java:102)
core.log.aop.reflection.profiler.AroundProfiler.invoke(AroundProfiler.java:19)
com.sun.proxy.$Proxy39.getUpdateCount(Unknown Source)
org.apache.ibatis.executor.resultset.DefaultResultSetHandler.getNextResultSet(DefaultResultSetHandler.java:256)
org.apache.ibatis.executor.resultset.DefaultResultSetHandler.handleResultSets(DefaultResultSetHandler.java:193)
org.apache.ibatis.executor.statement.PreparedStatementHandler.query(PreparedStatementHandler.java:64)

* * *

sun.reflect.GeneratedMethodAccessor140.invoke(Unknown Source)
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
java.lang.reflect.Method.invoke(Method.java:606)
org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:221)
org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:136)
org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:114)
org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:827)
```

#### 최적화된 데이터 수집

* 트랜잭션을 수행 중인 스레드에 대해서만 스택을 덤프합니다.

* 액티브 스택 덤프 시간 간격을 조정할 수 있습니다. `active_stack_second=10`

* 액티브 스택의 최대 라인에 제한되어 있습니다. Top 라인에서부터 기본 50라인을 수집합니다. `trace_active_callstack_depth=50`

* 액티브 스택의 각 라인은 해쉬 처리되어 수집됩니다. text는 한 번만 수집됩니다.

* 한 타임에 수집되는 최대 액티브 스택 개수도 제한되어 있습니다. `active_stack_count=100`

---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

와탭 PHP 모니터링 에이전트를 설치하기 전에 지원 환경을 확인하세요.

<!-- ## PHP 모니터링 에이전트 지원 환경 -->
<Tabs>
  <TabItem value="php-vs" label="PHP 버전" default>
  <ul>
        <li>PHP extension module</li>
        <li>PHP 5.2, 5.3, 5.4, 5.5, 5.6, 7.0, 7.1</li>
        <li>ZTS(Zend Thread Safe) 지원</li>
  </ul>
  </TabItem>
  <TabItem value="os" label="운영체제">
  <ul>
        <li>CentOS/Red Hat 6.x (64bit) 이상</li>
        <li>Debian/Ubuntu 12.04 (64bit) 이상</li>
        <li>Alpine Linux (64bit) </li>
        <li>FreeBSD 10.x (64bit) 이상</li>
  </ul>
  </TabItem>
  <TabItem value="db" label="데이터베이스">
  <ul>
        <li>Oracle(OCI8)</li> 
        <li>MySQL</li>
        <li>SQL Server</li>
        <li>PostgreSQL(psql)</li>
  </ul>
  </TabItem>
  <TabItem value="library" label="라이브러리">
  <ul>
        <li>PDO</li>
        <li>MySQLi</li>
        <li>cURL</li>
  </ul>
  </TabItem>
  <TabItem value="app-server" label="애플리케이션 서버">
  <ul>
        <li>Apache</li>
        <li>PHP-FPM(Nginx)</li>
  </ul>
  </TabItem>
</Tabs>    

## 에이전트 이름 식별
{@include: php-agent-name.mdx} 

## 모니터링 대상 식별

* **whatap.object_name** <span class='type'>String</span><br/>
    애플리케이션을 식별하는 에이전트 이름(ONAME) 체계입니다. ONAME을 토대로 OID가 생성됩니다. 

{@include: _php-restart-whatap-service.mdx}

|명칭|설명|
|----|----|
|{type}|whatap.app_name에 설정된 값을 사용합니다.|
|{ip#}|IP를 나누었을 때 #번째 자리를 사용합니다.|
|{process}|whatap.app_process_name에 설정된 값을 사용합니다.|
|{hostname}|서버 호스트명을 사용합니다.|

* **wwhatap.app_name**<span class='type'>String</span><br/>
    애플리케이션을 식별하는 에이전트 이름(ONAME) 체계에 사용되는 애플리케이션 명으로 object_name의 {type}에 해당하는 값입니다.

{@include: _php-restart-whatap-service.mdx}

## PHP 확장 모듈 및 whatap-php 서비스 등록

PHP 확장 모듈(PHP Extension module) 및 whatap-php 서비스(Service)를 자동으로 설치할 경우 아래와 같이 적용하세요.

``` javascript title=SH
$ sudo /usr/whatap/php/install.sh
Input license key
xxxxxxxxxxxxxxxx                          # 발급된 라이센스 key 입력

Input whatap.server.host
192.x.x.x                                  # 발급된 서버 IP 입력
```

PHP 확장 모듈(PHP Extension module) 및 whatap-php 서비스(Service)를 자동으로 인식하지 못하면 아래와 같이 선택 설치를 진행해야 합니다.

주로 Apache 명령어(`apachectl`, `httpd`, `apache2`) 및 PHP 명령어(CLI)가 기본 경로(*$PATH*)에 설정되어 있지 않거나, 여러 개의 PHP가 설치되어 PHP 명령어(CLI)가 여러 개일 경우(`php5`, `php70`, `php-zts`, `zts-php`…) 실제로 적용하고 있는 버전을 선택해 진행하세요.

```javascript title=SH
$ sudo /usr/whatap/php/install.sh manual

Input license key
xxxxxxxxxxxxxxxx                            # 발급된 라이센스 key 입력

Input whatap.server.host
192.x.x.x                                    # 발급된 서버 IP 입력

Input : which apache or php-fpm ex)/usr/sbin/httpd, /usr/sbin/apache2, /usr/sbin/php-fpm ...
/usr/sbin/httpd                             # apache 및 php-fpm 명령어 위치 입력

Input : which php ex) /usr/bin/php, /usr/bin/php5, /usr/bin/php70 ...
/usr/bin/php5                                # php 명령어 위치 입력
```

### 설정 스트립트 install.sh

```javascript title=SH
Usage: install.sh [ commands manual|remove ]
    install.sh -l <license> -s <server> -v <php version> -i <php config file> -p <process_name> [-z ]
    install.sh -l <license> -s <server> -e <php command> -p <process_name> [-z ]
Commands
    auto(default) Auto scan web server and php environment
    manual User input web server and php environment
    remove Remove php extension and service(whatap-php)
Options
    -v <php version>     PHP version ex) 5.3, 5.4, 5.5, 5.6, 7.0, 7.1, 7.2, 7.3, 7.4, 8.0                        -v 5.3
                           --php-version 5.3
    -i <php config file> PHP config file
                           -i /etc/php.ini
                           --php-ini /etc/php.ini
    -e <php cli>         PHP CLI(command line interface)
                           -e /usr/bin/php
                           --php-exe: /usr/bin/php-fpm
    -p <process name>    Web server or PHP-FPM process name. for get used memory
                           -p httpd
                           -p httpd.worker, -process-name: php-fpm
    -l <license>         License key
                           -l xxxxxxxxxxxxxxx,
                           --license: xxxxxxxxxxxxx
    -s <server>          WhaTap Server Host
                           -s xx.xx.xx.xx/yy.yy.yy.yy,
                           --server xxx.xxx.xxx.xxx
    -z                   PHP thread safe
                           -z ,
                           --php-zts
```

* **license**  
    발급된 프로젝트 액세스 키 입니다.

* **server**  
    발급된 서버 IP 입니다.

* **php version**  
    서버에 설치된 php 버전 정보 (5.2. 5.3, 5.4, 5.5, 5.6, 7.0, 7.1, 7.2, 7.3, 7.4, 8.0)

* **php config file**  
    서버에 설치된 php.ini의 전체 경로(*/etc/php.ini*) PHP Extension에 대한 설정을 진행합니다.

* **php cli**  
    커맨드 라인으로 실행 가능한 php 명령어의 전체 경로(*/usr/bin/php*) 해당 명령어로 PHP 기본 환경을 확인합니다.

* **process name**  
    Apache 실행 프로세스명(`httpd`, `apache2`, `httpd.worker`…) 또는 PHP-FPM의 실행 프로세스명(`php-fpm`, `php5-fpm`)으로 사용 메모리 정보를 수집합니다.

* **zts**  
    Zend Thread Safe 지원 여부를 설정합니다.    

#### PHP 버전 지정 설치

```javascript title=SH
$ /usr/whatap/php/install.sh -l [발급된 라이센스 key] -s [발급된 서버 IP] -v [PHP 버전 x.x] -i [php.ini의 전체 경로] -p [프로세스명]
$ /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -v 7.0 -i /etc/php.ini -p httpd [-z]
```

#### PHP Cli 명령어 지정 설치

```javascript title=SH
$ /usr/whatap/php/install.sh -l [발급된 라이센스 key] -s [발급된 서버 IP] -e [PHP Cli] -p [프로세스명]
$ /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -e /opt/php/bin/php -p apache2
$ /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -e /opt/php/bin/php-fpm -p php-fpm
```

#### JAVA

##### Tags

|태그명|설명|비고|
|----|----|----|
|container|컨테이너 이름|고유값|
|containerKey|컨테이너 키 값|고유값|
|host_ip|Host IP|고유값|
|okindName|애플리케이션 종류명|-|
|oname|애플리케이션 이름|고유값|
|onodeName|애플리케이션 노드명|-|
|pid|애플리케이션 PID|-|
|type|애플리케이션 유형|언어 이름|

##### Fields

|필드명|단위|설명|비고|
|----|----|----|----|
|cputime|밀리 세컨드|트랜잭션 cpu 시간|-|
|db_num_active|정수|DB Connection Pool Active 수|-|
|db_num_idle|정수|DB Connection Pool Idel 수|-|
|gc_count|회수|GC 발생 회수|-|
|gc_oldgen_count|건수|Old Generation GC 건수|-|
|gc_time|밀리 세컨드|GC 수행 시간|-|
|heap_max|바이트|힙 최대량|-|
|heap_perm|바이트|Perm 사용량|-|
|heap_tot|바이트|힙 총량|-|
|heap_use|바이트|힙 사용량|-|
|pending_finalization|정수||GC 중 fianlize 수행을 위해 대기 중인 객체 수|-|
|proc_fd|정수|프로세스 fd 사용수|-|
|proc_fd_max|정수|프로세스 fd 최대수|-|
|thread_count|정수|JVM 실행중인 쓰레드 수|-|
|thread_daemon|정수|JVM 데몬 쓰레드 수|-|
|thread_peak_count|정수||JVM 최대 쓰레드 수|-|
|thread_total_started|정수|JVM 실행 이후 총 start된 쓰레드 수|-|

#### PHP

##### Tags

|태그명|설명|비고|
|----|----|----|
|host_ip|Host IP|고유값|
|oname|애플리케이션 이름|고유값|
|okindName|애플리케이션 종류명|-|
|onodeName|애플리케이션 노드명|-|
|type|애플리케이션 유형|언어 이름|

##### Fields

|필드명|단위|설명|비고|
|----|----|----|----|
|mem_proc|바이트|PHP 프로세스 메모리 사용량|-|
|mem_system|바이트|시스템 메모리 전체 크기|-|