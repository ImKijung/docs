---
id: alpine-linux
title: Alpine Linux
description: Alpine Linux
tags:
    - Alpine Linux
    - Linux
    - PHP
---
<!-- 전체적으로 구조 다시 잡아야 함 -->
<!-- / 디렉터리 기준? -->
*whatap-php.tar.gz*을 다운받고 */* 디렉터리 기준으로 압축을 해제하세요.

*/usr/whatap/php* 디렉터리에 모니터링 설치 파일이 생성됩니다.

```bash
wget https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-php.tar.gz
tar -xvzf whatap-php.tar.gz -C /
```

PHP 확장 모듈(PHP Extension module) 및 whatap-php 데몬을 자동으로 설치할 경우 아래와 같이 적용하세요.

```bash
$ sudo /usr/whatap/php/install.sh
Input license key
xxxxxxxxxxxxxxxx                          # 발급된 라이센스 key 입력

Input whatap.server.host
192.x.x.x                                  # 발급된 서버 IP 입력
```

PHP 확장 모듈(PHP Extension module) 및 whatap-php 데몬을 자동으로 인식하지 못하는 경우 아래와 같이 선택 설치를 진행해야 합니다.

주로 Apache 명령어(`apachectl`, `httpd`, `apache2`) 및 PHP 명령어(CLI)가 기본 경로(*$PATH*)에 설정되어 있지 않거나, 여러 개의 PHP가 설치되어 PHP 명령어(CLI)가 여러 개일 경우에 (`php5`, `php70`, `php-zts`, `zts-php`…) 실제로 적용하고 있는 버전을 선택하여 진행하세요.

```bash
$ sudo /usr/whatap/php/install.sh manual

Input license key
xxxxxxxxxxxxxxxx                            # 발급된 라이센스 key 입력

Input whatap.server.host
192.x.x.x                                    # 발급된 서버 IP 입력

Input : which apache or php-fpm ex)/usr/sbin/httpd, /usr/sbin/apache2, /usr/sbin/php-fpm ...
/usr/sbin/httpd                             # apache 및 php-fpm 명령어 위치 입력

Input : which php ex) /usr/bin/php, /usr/bin/php5, /usr/bin/php70 ...
/usr/bin/php5                                # php 명령어 위치 입력
```

### 설정 스크립트 install.sh

```bash title=SH
Usage: install.sh [ commands manual|remove ]
    install.sh -l <license> -s <server> -v <php version> -i <php config file> -p <process_name> [-z ]
    install.sh -l <license> -s <server> -e <php command> -p <process_name> [-z ]
Commands
    auto(default) Auto scan web server and php environment
    manual User input web server and php environment
    remove Remove php extension and service(whatap-php)
Options
    -v <php version>     PHP version ex) 5.3, 5.4, 5.5, 5.6, 7.0, 7.1, 7.2, 7.3, 7.4, 8.0
                           -v 5.3
                           --php-version 5.3
    -i <php config file> PHP config file
                           -i /etc/php.ini
                           --php-ini /etc/php.ini
    -e <php cli>         PHP CLI(command line interface)
                           -e /usr/bin/php
                           --php-exe: /usr/bin/php-fpm
    -p <process name>    Web server or PHP-FPM process name. for get used memory
                           -p httpd
                           -p httpd.worker, -process-name: php-fpm
    -l <license>         License key
                           -l xxxxxxxxxxxxxxx
                           --license: xxxxxxxxxxxxx
    -s <server>          WhaTap Server Host
                           -s xx.xx.xx.xx/yy.yy.yy.yy
                           --server xxx.xxx.xxx.xxx
    -z                   PHP thread safe
                           -z
                           --php-zts
```
<!-- 옵션?? -->
* `license`  
    발급된 프로젝트 액세스 키를 확인합니다.

* `server`  
    발급된 서버 IP를 확인합니다.

* `php version`  
    서버에 설치된 php 버전 정보(5.2. 5.3, 5.4, 5.5, 5.6, 7.0, 7.1, 7.2)를 확인합니다.

* `php config file`  
    서버에 설치된 *php.ini*의 전체 경로(*/etc/php.ini*) PHP Extension에 대한 설정을 진행합니다.

* `php cli`  
    커맨드 라인으로 실행 가능한 php 명령어의 전체 경로(*/usr/bin/php*)에서 해당 명령어로 PHP 기본 환경을 확인합니다.

* `process name`  
    Apache 실행 프로세스명(`httpd`, `apache2`, `httpd.worker`…) 또는 PHP-FPM의 실행 프로세스명(`php-fpm`, `php5-fpm`) 해당 프로세스 명으로 사용 메모리 정보를 수집합니다.

* `zts`  
    Zend Thread Safe 지원 여부를 설정합니다.

### PHP 버전 지정 설치

```bash title=SH
$ /usr/whatap/php/install.sh -l [발급된 라이센스 key] -s [발급된 서버 IP] -v [PHP 버전 x.x] -i [php.ini 의 전체 경로] -p [프로세스명]
$ /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -v 7.0 -i /etc/php.ini -p httpd [-z]
```

### PHP Cli 명령어 지정 설치

```bash title=SH
$ /usr/whatap/php/install.sh -l [발급된 라이센스 key] -s [발급된 서버 IP] -e [PHP Cli] -p [프로세스명]
$ /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -e /opt/php/bin/php -p apache2
$ /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -e /opt/php/bin/php-fpm -p php-fpm
```

### whatap-php 실행

```bash title=SH
/usr/whatap/php/whatap-php
    Default restart
    Command start, stop, restart, version


## 버전 확인
# /usr/whatap/php/whatap-php version
0.8.5.20201209


## 실행 확인
# ps -elf | grep whatap
  103 root      0:05 ./whatap_php_static -t=4
```
설치가 완료된 후 Apache 또는 PHP-FPM 서비스를 다시 시작하면 설정된 PHP 확장 모듈 *whatap.so* 파일이 로딩됩니다.

### Dockerfile

*whatap-php.targ.gz* 을 */usr/whatap/php* 디렉터리에 압축을 해제하세요. `install.sh` 스크립트를 통해서 설치하세요.

```bash title=SH
FROM alpine

RUN apk update && apk upgrade
RUN apk add php7 php7-fpm php7-opcache
RUN apk add php7-gd php7-mysqli php7-zlib php7-curl
RUN apk add php7-pdo php7-pdo_mysql
RUN apk add php7-pgsql

RUN apk add apache2 php7-apache2

# Install WhaTap PHP monitoring
ADD whatap-php.tar.gz /
RUN wget https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-php.tar.gz
RUN tar -xvzf whatap-php.tar.gz -C /
RUN /usr/whatap/php/install.sh -l <라이센스> -s <Whatap server Host> -e <php CLI 경로> -p <프로세스 이름>
```

Docker의 entrypoint에 whatap-php 실행 명령어를 추가하여 container 실행 후에 whatap-php 데몬이 시작될 수 있도록 설정하세요.