---
id: nodejs-set-agent
title: Node.js 환경 설정
description: Node.js 에이전트 설정과 파일 구성 요소를 설명합니다.
tags: [ Node.js ]
---

와탭 에이전트는 에이전트 별 필요한 설정을 *whatap.conf* 파일에 작성합니다. 에이전트는 환경변수를 통해 설정 파일의 위치를 파악하고 로딩합니다. 컨테이너나 PaaS 환경에서 Node.js 서버가 동작하는 경우 환경 변수를 통해 에이전트 설정을 구성합니다.

:::note
Node.js 에이전트에서 설정할 수 있는 더 많은 옵션에 대한 설명은 [Node.js 모니터링 → 설정하기 → 부가 기능](nodejs-set-agent-adv)을 참조하세요.
:::

## 에이전트 이름 식별{#agentname}

와탭은 모니터링 정보 수집 대상인 애플리케이션 서버 식별을 위한 정보로 기본적으로 애플리케이션 서버로부터 수집한 정보를 활용합니다. 기본적으로 활용하는 정보는 애플리케이션 서버 유형 명칭(NODE), 애플리케이션 서버의 IP, 호스트 명 등을 조합해 애플리케이션 서버를 고유 식별자로 사용하게 되며 필요에 따라 사용자가 지정한 명칭을 사용하거나 패턴을 변경하여 사용하는 것도 가능합니다. 에이전트의 이름은 반드시 고유한 값이어야 합니다.

와탭 에이전트가 애플리케이션 서버를 식별하기 위해 사용하는 기본 패턴은 다음과 같습니다.

```ini title='기본 환경'
NODE-{ip2}-{ip3}
```

```ini title='클러스터(cluster) 환경'
NODE{cluster}-{ip2}-{ip3}
```

### 에이전트 이름 변수

| 변수       | 설명                                                                      |
| ---------- | ------------------------------------------------------------------------- |
| {type}     | 애플리케이션 유형 명칭(NODE)입니다.                                       |
| {ip0}      | IPv4 주소 중 첫 번째 단위를 사용합니다. (예시, **10**.11.12.13 중 **10**) |
| {ip1}      | IPv4 주소 중 두 번째 단위를 사용합니다. (예시, 10.**11**.12.13 중 **11**) |
| {ip2}      | IPv4 주소 중 세 번째 단위를 사용합니다. (예시, 10.11.**12**.13 중 **12**) |
| {ip3}      | IPv4 주소 중 네 번째 단위를 사용합니다. (예시, 10.11.12.**13** 중 **13**) |
| {pid}      | 애플리케이션 Process Id 입니다.                                           |
| {hostname} | 호스트 명칭입니다.                                                        |
| {cluster}  | 한 서버에 여러 Node.js가 동작할 때의 클러스터 id입니다.                   |

### 에이전트 이름 패턴 변경

환경 변수를 통해 와탭 에이전트 이름을 변경할 수 있습니다. 애플리케이션의 메인 모듈 파일의 최상단에 다음과 같이 코드를 추가하세요.

```javascript {1} showLineNumbers
process.env.WHATAP_NAME = "NODE-{ip2}-{ip3}";
var whatap=require('whatap').NodeAgent;
...
```

### 서버에서 에이전트 네이밍

에이전트 환경을 기반으로 이름을 결정하는 것이 아니라 서버에서 이름을 자동 부여하는 방식입니다. Node.js 서버가 컨테이너나 PaaS 환경에서 동작하는 경우에 활용합니다.

```ini title='whatap.conf' showLineNumbers
auto_oname_enabled=true
auto_oname_prefix=nodejs
```

```javascript title='env에 설정(app.js)' {4,5} showLineNumbers
process.env.WHATAP_LICENSE='x46n3226be1ah-z2rsecfcvlq2ph-z11bc81gfhqpgg';
process.env.WHATAP_SERVER_HOST='52.78.209.94/52.78.224.235';

process.env.auto_oname_enabled=true;
process.env.auto_oname_prefix='mynode';

var whatap=require('whatap').NodeAgent;
...
```

:::note
* env에 설정하려면 `require('whatap')`보다 먼저 선언되어야 합니다.
* **Heroku** 환경에서는 서버를 다시 시작할 때마다 IP 주소를 변경하기 때문에 새로운 이름으로 변경됩니다.
:::

`auto_oname_prefix` 옵션은 에이전트 이름의 prefix입니다. 와탭 서버는 `auto_oname_prefix` 옵션에 설정한 이름과 일련 번호를 합하여 에이전트 이름을 부여합니다.

> 부여한 에이전트 이름 예시, mynode1

whatap.conf 파일에 에이전트 이름과 관련한 자세한 내용은 [Node.js 모니터링 → 부가기능](nodejs-set-agent-adv#agentname)을 참조하세요.

## Network & security

와탭은 에이전트에 서버 방향을 TCP 연결 후 모니터링 데이터를 전송합니다.

![와탭 에이전트 네트워크](https://img.whatap.io/media/agent_node/agent_net.png)

에이전트는 하나의 TCP 세션을 통해서 데이터 전송과 서버의 제어 요청을 처리합니다. Node 에이전트는 UDP를 사용하지 않습니다. Node 에이전트에서 와탭 수집서버 방향으로 방화벽을 개방합니다.

### 수집 서버 주소와 포트

와탭 서버는 데이터 리전 서버와 프론트 서버, 유레카 등으로 구분합니다. 데이터 리전에는 다시 Proxy, Yard, Gateway, Keeper 등이 있습니다. 에이전트는 그중에 Proxy 서버와 통신을 합니다.

Node 에이전트에 와탭 서버의 proxy 서버의 주소를 설정합니다.(ex whatap.server.host=10.0.3.1/10.0.3.2) 서버 주소를 설정할 때는 proxy 서버 숫자만큼 입력합니다. 와탭 서버는 설치 방식에 따라서 proxy 서버를 1개 또는 여러 개를 사용할 수 있습니다.

와탭 Proxy 서버는 6600 포트에서 리스닝(Listening)합니다. 에이전트에서 별도 설정을 하지 않으면 에이전트는 6600 포트로 접속을 시도합니다.

```ini title='whatap.conf 포트 설정'
whatap.server.port=6600
```

:::note
두 개의 Proxy 서버가 서로 상이한 포트를 사용할 수 없습니다. 여러 대의 Proxy 서버를 사용하는 경우 리스닝(Listening) 포트는 동일해야 합니다.
:::

### 통신 연결 및 보안

와탭은 퍼블릭 네트워크에서 모니터링 데이터를 수집하는 것을 전제로 설계했습니다. 따라서 모든 모니터링 데이터를 암호화해 서버로 전송합니다. 많은 데이터를 암호화 전송하면 오버헤드를 유발할 수도 있습니다. 와탭은 데이터를 선별적으로 암호화합니다. 에이전트와 서버 사이의 통신 과정은 다음과 같습니다.

1. 프로젝트 생성 메뉴에서 프로젝트 액세스 키를 생성하고 복사하세요.
1. 프로젝트 액세스 키에는 비밀키를 포함합니다. 외부에 알려지지 않도록 주의하세요.
1. Node.js 애플리케이션 서버를 다시 시작하세요.
1. 와탭 에이전트는 서버로 TCP 세션을 연결합니다.
1. 프로젝트 액세스 키에 포함된 통신용 비밀키를 가지고 데이터를 암호화해 새로운 세션용 보안 키를 요청합니다.
1. 서버는 에이전트가 요청한 세션용 보안 키를 새로 만들어 에이전트에 내려보냅니다.
1. 세션용 보안키는 2개의 암호 키를 포함하고 있습니다. ASC 알고리즘용 암호 키와 단순 암호를 위한 암호 키입니다.
1. 이후에 에이전트는 텍스트와 제어 등 중요한 데이터는 ASC 암호 키를 사용합니다. 숫자 데이터와 같이 상대적으로 안전한 데이터는 단순 암호화를 거쳐 데이터를 서버에 전송합니다.

### 에이전트 통신 버퍼

에이전트는 서버 사이의 TCP 연결이 지연되면 에이전트 장애를 유발할 수 있습니다. 때문에 수집된 성능 데이터를 네트워크에 바로 전송하지 않습니다.

에이전트는 내부에 2개의 통신 버퍼를 가지고 통신합니다.

```ini
net_send_queue1_size=512
net_send_queue2_size=1024
```

**Queue1**에는 대부분의 성능 데이터 특히 정기적으로 전송하는 성능 데이터를 버퍼링하고 **Queue2**는 트랜잭션 프로파일(ProfilePack)과 액티브 스택(ActiveStackPack)만 별도 처리합니다.

에이전트는 큐를 기반으로 서버와 통신합니다. 서버가 다운되면 일정 부분은 에이전트가 메모리를 소비합니다. 그 이상의 문제는 발생하지 않습니다.

### 에이전트 다시 접속

에이전트는 서버와 연결이 끊어질 경우 5~10초마다 3번의 재연결을 시도합니다. 그 후에는 재연결을 시도하지 않습니다.