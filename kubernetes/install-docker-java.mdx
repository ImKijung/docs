---
id: install-docker-java
title: Docker Java 설치
description: 컨테이너 내 Java 애플리케이션을 모니터링하기 위한 에이전트 설치 단계입니다.
tags: [ 쿠버네티스, 쿠버네티스 모니터링, 애플리케이션 설치, Java ]
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Docker 컨테이너 기반으로 실행하는 Java 애플리케이션의 JVM Option에 에이전트 적용을 위한 설정을 추가하고, 컨테이너 이미지를 패키징하는 과정입니다.

## 에이전트 다운로드

<Tabs>
<TabItem value="dockerinstall" label="Docker Install" default>

1. 도커(Docker) 빌드 디렉터리를 생성하세요.

  ```bash
  mkdir -p {Docker build Dir}
  ```

1. *whatap.conf* 파일을 생성하세요.

  ```bash
  cat >{Docker build Dir}/whatap.conf <<EOL
  whatap.server.host=15.165.146.117
  EOL
  ```

  :::note
  *whatap.conf* 파일은 사용자 쿠버네티스 환경의 ConfigMap 기능을 통해 관리할 수 있습니다.
  :::

1. Dockerfile에 에이전트 설치용 이미지를 다운로드하려면 직접 해당 파일을 다운로드하거나 에이전트 파일을 이미지에 복사하세요.

  ```docker
  # 와탭 에이전트용 디렉터리를 사용자 컨테이너에 생성
  RUN mkdir -p /whatap

  # 와탭 Java 에이전트를 사용자 컨테이너에 복사
  COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-X.Y.Z.jar /whatap

  # 생성한 whatap.conf 설정 파일을 사용자 컨테이너에 복사
  COPY ./whatap.conf /whatap/    
  ```

  :::note

  *whatap.conf* 파일은 미리 생성해야 합니다.

  :::

1. 스크립트 또는 Dockerfile 명령어로 애플리케이션을 시작하세요.

    <Tabs>
    <TabItem value='script' label='스크립트' default>

    스크립트로 애플리케이션을 동작할 경우 다음 내용을 스크립트에 추가하세요.
    
    ```bash
    WHATAP_HOME=/whatap
    WHATAP_JAR=ls ${WHATAP_HOME}/whatap.agent-X.Y.Z.jar | sort | tail -1
    export JAVA_OPTS="-javaagent:${WHATAP_JAR} -Dwhatap.micro.enabled=true"
    ```

    </TabItem>
    <TabItem value='docker' label='Dockerfile 명령어'>
    
    Dockerfile 명령어로 애플리케이션을 시작하기 전에 에이전트의 버전을 확인하세요.

    ```docker
    docker run whatap/kube_mon ls /data/agent/micro –
    ```

    Dockerfile 애플리케이션 시작 명령어에 다음 내용을 추가하세요. **X.Y.Z** 부분에 앞서 확인한 에이전트 버전을 입력하세요.

    ```bash
    -javaagent:/whatap/whatap.agent-X.Y.Z.jar -Dwhatap.micro.enabled=true
    ```
    
    ```docker title='Dockerfile 예시'
    FROM openjdk:8-jdk-slim
    RUN mkdir -p /app && mkdir /whatap
    WORKDIR /app
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-X.Y.Z.jar /whatap
    COPY whatap.conf /whatap
    COPY myApp.jar /app/
    CMD ["java","-javaagent:/whatap/whatap.agent-X.Y.Z.jar","-Dwhatap.micro.enabled=true",”-jar”,"/app/myApp.jar"]
    EXPOSE 8080
    ```
    </TabItem>
    </Tabs>

1. Docker를 빌드하세요.

  ```docker
  cd docker
  docker build -t $Image_Name.
  ```

1. 사용자의 쿠버네티스 환경 내 컨테이너 환경 변수를 설정하세요. 애플리케이션 에이전트에 필요한 환경 변수 정보를 입력하세요.

  `OKIND` 환경 변수는 파드(Pod)에 해당하는 애플리케이션들을 같은 그룹으로 설정하는 역할을 합니다. 만약 디플로이먼트(Deployment) 이름으로 설정하면 해당하는 파드(Pod)들을 그룹화합니다.

  ```bash showLineNumbers {8-9}
  env:
    - name: NODE_IP
      valueFrom: {fieldRef: {fieldPath: status.hostIP}}
    - name: NODE_NAME
      valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
    - name: POD_NAME
      valueFrom: {fieldRef: {fieldPath: metadata.name}}
    - name: OKIND
      value: {업무 종류 이름 또는 Deployment 이름}
    - name: license
      value: XXXXXXXXXXXXXX-XXXXXXXXXXXXXX-XXXXXXXXXXXXXX  
  ```

1. 와탭 에이전트를 설치한 Docker 이미지로 배포하세요.

</TabItem>
<TabItem value="direct" label="직접 설치">

1. 설치 파일(*whatap.agent.java.tar.gz*)을 다운로드하려면 ***다운로드*** 버튼을 선택하세요.

1. Dockerfile을 작성할 수 있는 서버에 업로드한 다음 압축을 해제하세요.

    :::info
    
    설치할 서버에 직접 다운로드하려면 다음 명령어를 실행하세요.
    
    ```bash
    wget https://dev.whatap.io/agent/whatap.agent.java.tar.gz
    ```

    :::

1. *whatap.conf* 파일에서 설정 내용을 확인하세요.

    ```ini
    license=XXXXXXXXXXXXXX-XXXXXXXXXXXXXX-XXXXXXXXXXXXXX
    whatap.server.host=15.165.146.117
    ```

1. *paramkey.txt* 파일에서 설정 내용을 확인하세요. 6자리 영어, 숫자로 이루어진 비밀번호입니다.

```bash title='Dockerfile 생성 예시'
FROM openjdk:8-jdk-alpine

# whatap
RUN mkdir -p /whatap

COPY ./whatap/whatap.conf /whatap/
COPY ./whatap/paramkey.txt /whatap/
COPY ./whatap/whatap-virtual-X.Y.Z.jar whatap-virtual-X.Y.Z.jar
COPY ./whatap/whatap.agent-X.Y.Z.jar /whatap/

EXPOSE 8085

ENTRYPOINT ["java", "-javaagent:/whatap/whatap.agent-X.Y.Z.jar", "-Dwhatap.micro.enabled=true", "-cp", "whatap-virtual-X.Y.Z.jar", "-Dwhatap.port=8085", "-Duser.timezone=Asia/Seoul", "-Dfile.encoding=UTF-8", "com.virtual.App"]
```

:::note
* *whatap-virtual-X.Y.Z.jar*: 모니터링 대상(샘플 애플리케이션)
* *whatap.agent-X.Y.Z.jar*: 와탭 에이전트
* JVM 옵션 추가에 대한 자세한 내용은 [다음 문서](https://docs.whatap.io/java/install-agent#addjvmopt)를 참조하세요.
:::

</TabItem>
<TabItem value='eksfargate' label='EKS Fargate'>

1. 도커(Docker) 빌드 디렉터리를 생성하세요.

  ```bash
  mkdir -p {Docker build Dir}
  ```

1. *whatap.conf* 파일을 생성하세요.

  ```bash
  cat >{Docker build Dir}/whatap.conf <<EOL
  whatap.server.host=15.165.146.117
  master_agent_host=127.0.0.1
  EOL
  ```

  :::note
  *whatap.conf* 파일은 사용자 쿠버네티스 환경의 ConfigMap 기능을 통해 관리할 수 있습니다.
  :::

1. Dockerfile에 에이전트 설치용 이미지를 다운로드하려면 직접 해당 파일을 다운로드하거나 에이전트 파일을 이미지에 복사하세요.

  ```docker
  # 와탭 에이전트용 디렉터리를 사용자 컨테이너에 생성
  RUN mkdir -p /whatap

  # 와탭 Java 에이전트를 사용자 컨테이너에 복사
  COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-X.Y.Z.jar /whatap

  # 생성한 whatap.conf 설정 파일을 사용자 컨테이너에 복사
  COPY ./whatap.conf /whatap/    
  ```

  :::note

  *whatap.conf* 파일은 미리 생성해야 합니다.

  :::

1. 스크립트 또는 Dockerfile 명령어로 애플리케이션을 시작하세요.

    <Tabs>
    <TabItem value='script' label='스크립트' default>

    스크립트로 애플리케이션을 동작할 경우 다음 내용을 스크립트에 추가하세요.
    
    ```bash
    WHATAP_HOME=/whatap
    WHATAP_JAR=ls ${WHATAP_HOME}/whatap.agent-X.Y.Z.jar | sort | tail -1
    export JAVA_OPTS="-javaagent:${WHATAP_JAR} -Dwhatap.micro.enabled=true"
    ```

    </TabItem>
    <TabItem value='docker' label='Dockerfile 명령어'>
    
    Dockerfile 명령어로 애플리케이션을 시작하기 전에 에이전트의 버전을 확인하세요.

    ```docker
    docker run whatap/kube_mon ls /data/agent/micro –
    ```

    Dockerfile 애플리케이션 시작 명령어에 다음 내용을 추가하세요. **X.Y.Z** 부분에 앞서 확인한 에이전트 버전을 입력하세요.

    ```bash
    -javaagent:/whatap/whatap.agent-X.Y.Z.jar -Dwhatap.micro.enabled=true
    ```
    
    ```docker title='Dockerfile 예시'
    FROM openjdk:8-jdk-slim
    RUN mkdir -p /app && mkdir /whatap
    WORKDIR /app
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-X.Y.Z.jar /whatap
    COPY whatap.conf /whatap
    COPY myApp.jar /app/
    CMD ["java","-javaagent:/whatap/whatap.agent-X.Y.Z.jar","-Dwhatap.micro.enabled=true",”-jar”,"/app/myApp.jar"]
    EXPOSE 8080
    ```
    </TabItem>
    </Tabs>

1. Docker를 빌드하세요.

    ```docker
    cd docker
    docker build -t $Image_Name.
    ```

1. 디플로이먼트(Deployment) 또는 레플리카셋(ReplicaSet)의 *.spec* 내 필드에 사용자 파드(Pod) 자원 관측을 위한 `shareProcessNamespace`, `serviceAccount`를 추가하세요.

    ```ini
    apiVersion: apps/v1
    kind: Deployment
    ...
    spec:
    ...
        spec:
          shareProcessNamespace: true
          serviceAccount: whatap
    ...
    ```

1. 사용자의 쿠버네티스 환경 내 컨테이너 환경 변수를 설정하세요. 애플리케이션 에이전트에 필요한 환경 변수 정보를 입력하세요.

  `OKIND` 환경 변수는 파드(Pod)에 해당하는 애플리케이션들을 같은 그룹으로 설정하는 역할을 합니다. 만약 디플로이먼트(Deployment) 이름으로 설정하면 해당하는 파드(Pod)들을 그룹화합니다.

    ```ini showLineNumbers {8-9}
    env:
      - name: NODE_IP
        valueFrom: {fieldRef: {fieldPath: status.hostIP}}
      - name: NODE_NAME
        valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
      - name: POD_NAME
        valueFrom: {fieldRef: {fieldPath: metadata.name}}
      - name: OKIND
        value: {업무 종류 이름 또는 Deployment 이름}
      - name: license
        value: XXXXXXXXXXXXXX-XXXXXXXXXXXXXX-XXXXXXXXXXXXXX  
    ```

1. 사용자 파드(Pod) 자원 사용량을 수집하는 whatap-node-agent sidecar 컨테이너를 추가하세요.

    ```ini
    ...
      - name: whatap-node-agent
        image: whatap/kube_mon_sidecar
        resources:
          requests:
            memory: 20Mi
            cpu: 10m
          limits:
            memory: 40Mi
            cpu: 20m
        ports:
          - name: nodeport
            containerPort: 6600
        env:
          - name: NODE_IP
            valueFrom:
              fieldRef:
                fieldPath: status.hostIP
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
            envFrom:
            - configMapRef:
                name: node-license
    volumes:
    ...
    ```

1. 와탭 에이전트를 설치한 Docker 이미지로 배포하세요.


</TabItem>
</Tabs>

## 에이전트 설치 확인

에이전트를 제대로 설치했는지 확인하려면 ***대시보드*** > ***애플리케이션 서비스 대시보드*** 메뉴로 이동하세요.

다운로드한 파일을 직접 설치한 다음, ***대시보드*** 메뉴에서 에이전트를 확인할 수 없다면 다음 사항을 확인하세요.

* 컨테이너에서 `ps -ef | grep whatap` 명령어를 실행해 에이전트 옵션을 적용했는지 확인하세요.
* 컨테이너의 */whatap/logs* 경로의 내용을 확인하세요. 에이전트 로그는 *logs/{whatap 설정파일명}-yyyymmdd.log* 형식의 파일명으로 출력됩니다.

