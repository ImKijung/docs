---
id: install-docker-php
title: Docker PHP 설치
description: 컨테이너 내 PHP 애플리케이션을 모니터링하기 위한 에이전트 설치 단계입니다.
tags: [ 쿠버네티스, 쿠버네티스 모니터링, 애플리케이션 설치, PHP ]
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Docker 컨테이너 기반으로 실행하는 PHP 애플리케이션에 와탭 모니터링 에이전트를 적용하고, 컨테이너 이미지를 패키징하는 과정입니다.

## 에이전트 다운로드

PHP 애플리케이션 도커 이미지 빌드 시 whatap-php 패키지를 설치하세요.



<Tabs>
<TabItem value="rc" label="Redhat/CentOS" default>

```docker title='Redhat/CentOS'

RUN rpm -Uvh https://repo.whatap.io/centos/5/noarch/whatap-repo-1.0-1.noarch.rpm
RUN yum install -y whatap-php

```

</TabItem>

<TabItem value="du" label="Debian/Ubuntu" default>

```docker title='Debian/Ubuntu'

RUN wget https://repo.whatap.io/debian/release.gpg -O -| apt-key add -
RUN wget https://repo.whatap.io/debian/whatap-repo_1.0_all.deb
RUN dpkg -i whatap-repo_1.0_all.deb
RUN apt-get update
RUN apt-get install -y whatap-php

```

</TabItem>

<TabItem value="al" label="Amazon Linux" default>

```docker title='Amazon Linux'

RUN rpm --import https://repo.whatap.io/centos/release.gpg
RUN echo "[whatap]" | tee /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "name=whatap packages for enterprise linux" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "baseurl=https://repo.whatap.io/centos/latest/\$basearch" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "enabled=1" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "gpgcheck=0" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN yum install -y whatap-php

```

</TabItem>

<TabItem value="apl" label="Alpine Linux" default>

```docker title='Alpine Linux"'

RUN wget https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-php.tar.gz
RUN tar -xvzf whatap-php.tar.gz -C /

```

</TabItem>

</Tabs>

## 에이전트 설정

* 다음 명령어를 이용해 설치 스크립트를 설정하세요. 와탭 액세스 키, 서버 IP 정보를 입력하면 PHP 환경 정보를 자동으로 수집합니다.

  ```docker

  RUN (echo "[액세스 키]"; echo "[서버 IP]")|/usr/whatap/php/install.sh

  ```

* 다음과 같이 PHP 환경 정보를 직접 입력할 수 있습니다. 

  ```docker

  # RUN /usr/whatap/php/install.sh -l 액세스 키] -s [서버 IP] -v [PHP 버전 x.x] -i [php.ini의 전체 경로] -p [프로세스명] -z [thread safety]
  RUN /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -v 7.0 -i /etc/php.ini -p httpd [-z]

  ```

## Kubernetes 환경 변수 및 볼륨

다음 안내에 따라 환경 변수 및 볼륨을 설정하세요.

<Tabs>
<TabItem value="basic" label="기본" default>

트랜잭션에서 NODE 및 POD정보를 수집하기 위해 `NODE_IP`, `NODE_NAME`, `POD_NAME`을 환경 변수로 설정합니다. 와탭 설정 파일 및 로그 파일용 휘발성 볼륨을 탑재합니다.

```docker

env:
- name: NODE_IP
  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
- name: NODE_NAME
  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
- name: POD_NAME
  valueFrom: {fieldRef: {fieldPath: metadata.name}}

```

</TabItem>

<TabItem value="eks" label="EKS Fargate" default>

* **shareProcessNamespace 설정 추가**

  디플로이먼트(Deployment) 또는 레플리카셋(ReplicaSet)의 *.spec* 내 필드에 사용자 파드(Pod) 자원 관측을 위한 `shareProcessNamespace`, `SERVICE ACCOUNT`를 추가하세요.


  ```docker

  apiVersion: apps/v1
  kind: Deployment
  ...
  spec:
  ...
      spec:
        shareProcessNamespace: true
        serviceAccount: whatap
  ...

  ```

* **Kubernetes의 컨테이너 환경 변수 설정**

  트랜잭션에서 NODE 및 POD정보를 수집하기 위해 `NODE_IP`, `NODE_NAME`, `POD_NAME`을 환경 변수로 설정합니다. 와탭 설정 파일 및 로그 파일용 휘발성 볼륨을 탑재합니다.

  ```docker 

  env:
  - name: NODE_IP
    valueFrom: {fieldRef: {fieldPath: status.hostIP}}
  - name: NODE_NAME
    valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
  - name: POD_NAME
    valueFrom: {fieldRef: {fieldPath: metadata.name}}

  ```


* **사이드카(Sidecar) 에이전트 추가**

  사용자 파드(Pod) 자원 사용량을 수집하는 whatap-node-agent sidecar 컨테이너를 추가하세요.

  ```docker

  ...
    - name: whatap-node-agent
      image: whatap/kube_mon_sidecar
      resources:
        requests:
          memory: 20Mi
          cpu: 10m
        limits:
          memory: 40Mi
          cpu: 20m
      ports:
        - name: nodeport
          containerPort: 6600
      env:
        - name: NODE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
          envFrom:
          - configMapRef:
              name: node-license
  volumes:
  ...

  ```

</TabItem>

</Tabs>


## 애플리케이션 모니터링 시작하기

<Tabs>
<TabItem value="cm" label="Command" default>

애플리케이션 시작 명령어 앞에 추가로 whatap-php 서비스 시작 명령어를 추가하세요. 

```docker title='Redhat/CentOS, Debian/Ubuntu, Amazon Linux'

sh -c "/etc/init.d/whatap-php start && [애플리케이션 시작 명령어]"

```

```docker title='Alpine Linux'

sh -c "/usr/whatap/php/whatap-php start && [애플리케이션 시작 명령어]"

```

</TabItem>

<TabItem value="sup" label="Supervisor" default>

Supervisor로 애플리케이션을 시작하는 경우 다음 코드를 참조해 whatap-php 서비스를 추가하세요.

```docker

RUN echo "[program:whatap-php]" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "command = /etc/init.d/whatap-php start" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "user = root" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "autostart = true" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "autorestart = true" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stdout_logfile = /dev/stdout" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stdout_logfile_maxbytes=0" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stderr_logfile = /dev/stderr" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stderr_logfile_maxbytes=0" >> /etc/supervisor/conf.d/whatap.conf

```

</TabItem>

</Tabs>

다음 명령어를 실행해 와탭 서비스가 정상 실행되었는지 확인하세요. 

```docker

ps -ef | grep whatap_php

```

{@include: _check-install-agent.mdx}

