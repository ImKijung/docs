---
id: install-application-agent
title: 애플리케이션 에이전트 설치
description: 컨테이너 내 Java, Python, Node.js 등의 애플리케이션을 모니터링하기 위한 에이전트 설치 단계입니다.
tags: [ 쿠버네티스, 쿠버네티스 모니터링, 애플리케이션 설치, Java, Node.js, Python ]
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

컨테이너 내 Java, Python, Node.js 등의 애플리케이션을 모니터링하기 위한 에이전트 설치 단계입니다.

마이크로 애플리케이션 에이전트의 설치는 와탭의 애플리케이션 모니터링 에이전트 설치 절차와 동일합니다. 다만 컨테이너화(Containerization) 작업이 추가되는 것이 다릅니다. 다음 링크를 참조하세요.

* [Java 에이전트 설치](java/install-agent)
* [Python 에이전트 설치](apm/python-install-agent)
* [Node.js 에이전트 설치](nodejs/install-agent)

![Application Agent](/img/kube-apm-agent.png)

프로젝트 생성 화면에서 위쪽에 위치한 ![지시선 1](/img/number-01.png) ***Application Agent*** 탭을 선택하세요. (홈 화면 > 프로젝트 선택 > ***관리*** > ***에이전트 설치*** > ***Application Agent***)

## 프로젝트 액세스 키 확인

![프로젝트 액세스 키 확인](https://img.whatap.io/media/images/whatap_kubernetes_application_agent_access_key.png)

설치 안내 페이지의 ***프로젝트 액세스 키 확인*** 섹션에서 ***프로젝트 액세스 키 발급받기*** 버튼을 선택하세요. 이미 발급 받은 경우 액세스 키가 표시됩니다.

## 애플리케이션 에이전트 컨테이너화

<Tabs>
<TabItem value="java" label="Java" default>

Docker 컨테이너 기반으로 실행하는 Java 애플리케이션의 JVM Option에 에이전트 적용을 위한 설정을 추가하고, 컨테이너 이미지를 패키징하는 과정입니다.

1. 애플리케이션의 Dockerfile이 있는 경로에 *whatap.conf* 파일을 생성하세요.

  ```bash
  # Docker 빌드 경로 생성
  $ mkdir -p {Docker build Dir}
  
  # whatap.conf 파일 생성  
  $ cat >{Docker build Dir}/whatap.conf <
  whatap.server.host=13.124.11.223/13.209.172.35
  EOL
  ```

  :::note
  *whatap.conf* 파일은 사용자 쿠버네티스 환경의 ConfigMap 기능을 통해 관리할 수도 있습니다.
  :::

1. Dockerfile에 와탭 에이전트 설치용 이미지를 불러와 다운로드하는 명령어(절차)를 추가하세요.

  ```docker
  # 와탭 에이전트용 디렉토리를 사용자 컨테이너에 생성
  RUN mkdir -p /whatap

  # 와탭 Java 에이전트를 사용자 컨테이너에 복사
  COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent.kube.jar /whatap

  # 생성한 whatap.conf 설정 파일을 사용자 컨테이너에 복사
  COPY ./whatap.conf /whatap/    
  ```

1. `javaagent` 옵션을 추가하세요.

    * 스크립트로 애플리케이션을 동작할 경우 다음 내용을 스크립트에 추가하세요.

      ```bash
      WHATAP_HOME=/whatap
      WHATAP_JAR=ls ${WHATAP_HOME}/whatap.agent.kube.jar | sort | tail -1
      export JAVA_OPTS="-javaagent:${WHATAP_JAR} -Dwhatap.micro.enabled=true "
      ```

    * Dockerfile 명령어로 애플리케이션을 동작할 경우 에이전트 버전을 확인하세요.

      ```docker
      docker run whatap/kube_mon ls /data/agent/micro –
      ```

      Dockerfile 애플리케이션 동작 명령어에 다음 내용을 추가하세요.

      ```docker title='Dockerfile 샘플' {7-8} showLineNumbers
      FROM openjdk:8-jdk-slim
      RUN mkdir -p /app && mkdir /whatap
      WORKDIR /app
      COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent.kube.jar /whatap
      COPY whatap.conf /whatap
      COPY myApp.jar /app/
      # 애플리케이션 동작 명령어 추가
      CMD ["java","-javaagent:/whatap/whatap.agent.kube.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
      EXPOSE 8080
      ```

1. Docker를 빌드하세요.

  ```docker
  cd docker
  docker build -t $Image_Name.
  ```

1. 사용자의 쿠버네티스 환경 내 컨테이너 환경 변수를 설정하세요. 애플리케이션 에이전트에 필요한 환경 변수 정보를 추가합니다.

  `OKIND` 환경 변수는 Pod에 해당하는 애플리케이션들을 같은 그룹으로 설정하는 역할을 합니다. 만약 Deployment 이름으로 설정하면 Deployment에 속하는 Pod들을 하나로 그룹화합니다.

  ```bash {8-9} showLineNumbers
  env:
    - name: NODE_IP
      valueFrom: {fieldRef: {fieldPath: status.hostIP}}
    - name: NODE_NAME
      valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
    - name: POD_NAME
      valueFrom: {fieldRef: {fieldPath: metadata.name}}
    - name: OKIND
      value: {업무 서비스 이름 또는 Deployment 이름}
    - name: license
      value: {프로젝트 액세스 키: 예시, x4beh20bjgp2s-x6uprtmp409mvc-.....}
  ```

1. 와탭 에이전트를 설치한 Docker를 이미지로 배포하세요.

</TabItem>
<TabItem value="nodejs" label="Node.js">

Docker 컨테이너 기반으로 실행하는 Node.js 애플리케이션에 와탭 모니터링 에이전트를 적용하고, 컨테이너 이미지를 패키징하는 과정입니다.

1. Node.js 애플리케이션을 위한 와탭 모니터링 에이전트를 다음 명령어를 통해 설치하세요.

    ```bash
    npm install --save whatap

    # 업데이트
    npm updatae whatap
    ```

1. *node_modules/whatap* 경로의 *whatap.conf* 파일을 Node.js 애플리케이션 루트 경로로 복사하세요. 

1. 복사한 *whatap.conf* 파일의 내용을 ***에이전트 설치*** > ***Application Agent*** > ***Docker NodeJS*** 페이지에서 가이드하는 내용으로 교체하세요.

    ```ini title='whatap.conf'
    license=<프로젝트 액세스 키>
    whatap.server.host=<와탭 수집서버 IP>
    whatap_micro_enabled=true
    ```

1. 루트 경로의 Node.js 애플리케이션에 다음 코드를 추가하세요.

    ```javascript
    var WhatapAgent = require('whatap').NodeAgent;
    ```

1. 트랜잭션에서 Node 및 Pod 정보를 수집하기 위해 NODE_IP, NODE_NAME, POD_NAME 환경 변수를 설정합니다. 와탭 설정 파일 및 로그 파일용 휘발성 볼륨을 탑재합니다.

    ```bash
    env:
      - name: NODE_IP
        valueFrom: {fieldRef: {fieldPath: status.hostIP}}
      - name: NODE_NAME
        valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
      - name: POD_NAME
        valueFrom: {fieldRef: {fieldPath: metadata.name}}
    ```
  
  애플리케이션 내에 *whatap.conf* 파일을 사용하지 않는 경우 위 설정에 이어 다음 코드를 추가하세요.

    ```bash
    - name: license
      value: <프로젝트 액세스 키 / 예) x4beh20bjgp2s-x6uprtmp409mvc-.....>
    - name: whatap_server_host
      value: "<와탭 수집서버 IP / 예) 13.124.11.223/13.209.172.35>"
    - name: whatap_micro_enabled
      value: "true"
    ```

1. 와탭 에이전트를 설치한 Docker를 이미지로 배포하세요.

</TabItem>
<TabItem value="python" label="Python">

Docker 컨테이너 기반으로 실행하는 Python 애플리케이션에 와탭 모니터링 에이전트를 적용하고, 컨테이너 이미지를 패키징하는 과정입니다.

1. Python 애플리케이션 도커 이미지 빌드 시 whatap-python 패키지를 설치하세요.

    ```docker title='python 3.7 버전'
    RUN pip3 install --upgrade whatap-python
    ```

1. Python 애플리케이션 시작 시 와탭 에이전트가 Injection할 수 있도록 애플리케이션 시작 스크립트를 수정하세요. 설정 파일 및 로그 출력 경로를 환경변수 `WHATAP_HOME`으로 설정합니다.

    ```bash
    export WHATAP_HOME=/whatap_conf
    ```

  설정 파일을 생성하세요.

    ```bash
    whatap-setting-config\
    --host 13.124.11.223/13.209.172.35\
    --license x4beh20bjgp2s-x6uprtmp409mvc-z3sl51qhqps7q7\
    --app_name {애플리케이션 이름}\
    --app_process_name {애플리케이션 프로세스 이름}
    ```

1. 트랜잭션에서 Node 및 Pod 정보를 수집하기 위해 NODE_IP, NODE_NAME, POD_NAME 환경 변수를 설정합니다. 와탭 설정 파일 및 로그 파일용 휘발성 볼륨을 탑재합니다.

    ```bash
    env:
      - name: NODE_IP
        valueFrom: {fieldRef: {fieldPath: status.hostIP}}
      - name: NODE_NAME
        valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
      - name: POD_NAME
        valueFrom: {fieldRef: {fieldPath: metadata.name}}
    ```

  애플리케이션 내에 *whatap.conf* 파일을 사용하지 않는 경우 위 설정에 이어 다음 코드를 추가하세요.

    ```bash
    - name: license
      value: <프로젝트 액세스 키 / 예) x4beh20bjgp2s-x6uprtmp409mvc-.....>
    - name: whatap_server_host
      value: "<와탭 수집서버 IP / 예) 13.124.11.223/13.209.172.35>"
    - name: whatap_micro_enabled
      value: "true"
    ```

1. 와탭 에이전트를 설치한 Docker를 이미지로 배포하세요.

:::note
* 다음의 경우 권한 문제가 발생할 수 있습니다.
  - 와탭 설정을 위한 $WHATPA_HOME/whatap.conf 파일의 읽기 및 쓰기 권한
  - 와탭 로그를 위한 $WHATPA_HOME/logs 디렉토리와 하위 파일의 읽기 및 쓰기 권한
* 권한 문제가 발생하는 경우 다음과 같이 `$WHATAP_HOME` 변수에 권한을 부여하세요.
    ```bash
    echo 'sudo chmod -R 777 $WHATAP_HOME'
    ```
:::

</TabItem>
</Tabs>